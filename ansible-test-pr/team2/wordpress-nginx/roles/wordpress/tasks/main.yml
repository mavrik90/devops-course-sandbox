---
- name: Download WordPress
  get_url: 
    url: "http://wordpress.org/wordpress-{{ wp_version }}.tar.gz dest={{ wordpress.home }}-{{ wp_version }}.tar.gz"
    sha256sum: "{{ wp_sha256sum }}"

- name: Extract archive
  unarchive:
    creates: "{{ wordpress.home }}"
    src: "{{ wordpress.home }}-{{ wp_version }}.tar.gz"
    dest: "{{ wordpress.home }}"

- name: Add group "wordpress"
  group: 
   name: "{{ wordpress.user }}"

- name: Add user "wordpress"
  user: 
   name: "{{ wordpress.user }}"
   group: "{{ wordpress.group }}"
   home: "{{ wordpress.home }}"

- name: Fetch random salts for WordPress config
  get_url:
    url: https://api.wordpress.org/secret-key/1.1/salt/
  register: "wp_salt"
  become: no
  become_method: sudo
  changed_when: true
  delegate_to: localhost

- name: Create WordPress database
  mysql_db: 
    name: "{{ wp_db_name }}" 
    state: present

- name: Create WordPress database user
  mysql_user: 
   name: "{{ wp_db_user }}" 
   password: "{{ wp_db_password }}" 
   priv: "{{ wp_db_name }}.*:ALL" 
   host: 'localhost' 
   state: present

- name: Copy WordPress config file
  template: 
   src: wp-config.php 
   dest: "{{ wordpress.home }}"

- name: Change ownership of WordPress installation
  file: 
   path: "{{ wordpress.home }}" 
   owner: "{{ wordpress.user }}"
   group: "{{ wordpress.group }}"
   state: directory 
   recurse: yes 
   setype: httpd_sys_content_t

- name: Start php-fpm Service
  service: 
   name: php-fpm 
   state: started 
   enabled: yes
